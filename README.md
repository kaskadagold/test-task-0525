# Тестовое задание (PHP full-stack программист)
<i>Цель:</i> разработать микро-црм для торговли.

- Требуется реализовать набор REST-методов, которые позволят:
    - Просмотреть список складов
    - Просмотреть список товаров с их остатками по складам
    - Получить список заказов (с фильтрами и настраиваемой пагинацией)
    - Создать заказ (в заказе может быть несколько позиций с разным количеством)
    - Обновить заказ (данные покупателя и список позиций, но не статус)
    - Завершить заказ
    - Отменить заказ
    - Возобновить заказ (перевод из отмены в работу)
При этом товары должны корректно списываться\возвращаться на остаток. Если операцию невозможно выполнить (возврат в работу заказа, когда товаров уже нет), необходимо вернуть ошибку.
- Реализовать историю движения товаров (изменение количества товара на статке склада). Создать таблицу движений, модель, а также REST-метод для просмотра истории изменений. Метод должен поддерживать фильтры (по складу, по товару, по датам), а также настраиваемую пагинацию.
- Наполнить готовыми тестовыми данными справочники товаров, складов и остатков. Наполнение должно происходить путём вызова консольной команды. 

## Содержание
- [Технологии](#технологии)
- [Описание](#описание)
- [Использование](#использование)
    - [Требования](#требования) 
    - [Установка](#установка)

## Технологии
- PHP 8.2
- Laravel 10
- MySQL 8.0
- HTML5, CSS3
- Composer 2.7

## Описание
Для использования всех реализованных методов при отправке запроса необходимо добавить заголовок `Accept: application/json`. При передаче тела запроса (параметров пагинации, полей фильтрации, данных для создания/изменений заказа) ожидается, что тело передается в JSON-формате (`Content-Type: application/json`).

Описание методов:
1. Просмотр списка складов:
    - путь: `/warehouses`
    - метод: `GET`
    - возможные query-параметры: нет
    - возможное тело запроса: не подразумевается

2. Просмотр списка товаров с их остатками по складам:
    - путь: `/products`
    - метод: `GET`
    - возможные query-параметры: нет
    - возможное тело запроса: не подразумевается

3. Получение списка заказов с фильтрами и настраиваемой пигинацией:
    - путь: `/orders`
    - метод: `GET`
    - возможные query-параметры:
        - `page`: передача номера просматриваемой страницы
            Пример: ```page=1```
    - возможное тело запроса:
        - `perPage`: сколько элементов отображать на одной странице
            - обязательность: нет (по умолчанию - 5)
            - тип: integer
            - пример: ```"perPage": 6```
        - `filters`: список параметров фильтрации
            - обязательность: нет
            - тип: объект
            - поля: 
                - `customer` (имя клиента), `warehouse` (название склада), `status` (статус заказа)
                    - тип: объект
                    - возможные поля:
                        - `order`: направление сортировки
                            - возможные значения: `order_asc`, `order_desc`
                        - `opeartor`: тип сравнения
                            - возможные значения: `=`, `like` (кроме `status`)
                        - `value`: значение для поиска
                            - необходимо при указании `operator`
                            - тип: string
                - `created_at` (время создания заказа), `completed_at` (время завершения заказа)
                    - тип: объект
                    - возможные поля:
                        - `order`: направление сортировки
                            - возможные значения: `order_asc`, `order_desc`
                        - `opeartor`: тип сравнения
                            - возможные значения: `=`, `after`, `before`, `between`
                                дополнительные значения для `completed_at`: `is_null`, `is_not_null`
                        - `value`: значение для поиска
                            - тип: date
                            - необходимо при указании `operator`, если `operator` != `is_null`/`is_not_null`/`between`
                        - `value_start`: значение начала диапазона
                            - тип: date
                            - необходимо, если `operator` = `between`
                        - `value_end`: значение конца диапазона
                            - тип: date
                            - необходимо, если `operator` = `between`
            - пример:
            ```
            {
                "filters": {
                    "customer": {
                        "order": "order_asc"
                    },
                    "created_at": {
                        "order": "order_asc",
                        "operator": "after",
                        "value": "2025-05-12 10:00:00"
                    }
                }
            }
            ```

4. Создание заказа (в заказе может быть несколько позиций с разным количеством):
    - путь: `/orders`
    - метод: `POST`
    - возможные query-параметры: нет
    - тело запроса:
        - `customer`: имя клиента
            - обязательность: да
            - тип: string
            - пример: ```"customer": "Name"```
        - `warehouse_id`: id склада, с которого подразумевается изъятие продуктов заказа
            - обязательность: да
            - тип: integer
            - пример: ```"warehouse_id": 1```
        - `products`:
            - обязательность: да
            - тип: array
            - элементы:
                - тип: объект
                - поля:
                    - `id`: id продукта, добавленного в заказ (integer)
                    - `count`: заказанное количество этого продукта (integer)
        - пример:
        ```
        {
            "customer": "Name",
            "warehouse_id": 1,
            "products": [
                {
                    "id": 2,
                    "count": 1
                },
                {
                    "id": 5,
                    "count": 1
                }
            ]
        }
        ```
    - возможные ошибки:
        - если указанный id склада не существует, то возникнет ошибка с сообщением "Не существует склада с id = %d"
        - при попытке добавить в заказ продукт, которого не существует на привязанном к заказу складе, возникнет ошибка с сообщением "Невозможно выполнить: на складе (id = %d) не существует товара (id = %d)"
        - при попытке добавить в заказ продукт, количество которого на складе не достаточно для заказа, возникнет ошибка с сообщением "Невозможно выполнить: на складе (id = %d) недостаточно товара (id = %d)"

5. Обновление заказа (данные покупателя и список позиций):
    - путь: `/orders/{order_id}`
    - метод: `PUT`
    - возможные query-параметры: нет
    - возможное тело запроса:
        - `customer`: имя клиента
            - обязательность: нет
            - тип: string
            - пример: ```"customer": "Name"```
        - `products`:
            - обязательность: нет
            - тип: array
            - элементы:
                - тип: объект
                - поля:
                    - `id`: id продукта, добавленного в заказ (integer)
                    - `count`: заказанное количество этого продукта (integer)
        - пример:
        ```
        {
            "customer": "New Name",
            "products": [
                {
                    "id": 2,
                    "count": 3
                }
            ]
        }
        ```
    - возможные ошибки:
        - при попытке добавить в заказ продукт, которого не существует на привязанном к заказу складе, возникнет ошибка с сообщением "Невозможно выполнить: на складе (id = %d) не существует товара (id = %d)"
        - при попытке добавить в заказ продукт, количество которого на складе не достаточно для заказа, возникнет ошибка с сообщением "Невозможно выполнить: на складе (id = %d) недостаточно товара (id = %d)"
        - при попытке обновить уже завершенный заказ (статус которого `completed`), возникнет ошибка с сообщением "Нельзя обновить завершённый заказ"
        - при обращении к несуществующему заказу, возникнет ошибка с сообщением "Не существует заказа с id = %d"

6. Завершение заказа:
    - путь: `/orders/{order_id}/complete`
    - метод: `PATCH`
    - возможные query-параметры: нет
    - возможное тело запроса: не подразумевается
    - возможные ошибки:
        - при попытке завершить уже завершенный заказ (статус которого `completed`), возникнет ошибка с сообщением "Заказ уже был завершён"
        - при попытке завершить отмененный заказ (статус которого `canceled`), возникнет ошибка с сообщением "Нельзя завершить отменённый заказ"
        - при обращении к несуществующему заказу, возникнет ошибка с сообщением "Не существует заказа с id = %d"

7. Отмена заказа:
    - путь: `/orders/{order_id}/cancel`
    - метод: `PATCH`
    - возможные query-параметры: нет
    - возможное тело запроса: не подразумевается
    - возможные ошибки:
        - при попытке отменить завершенный заказ (статус которого `completed`), возникнет ошибка с сообщением "Нельзя отменить завершённый заказ"
        - при попытке отменить уже отмененный заказ (статус которого `canceled`), возникнет ошибка с сообщением "Заказ уже был отменён"
        - при обращении к несуществующему заказу, возникнет ошибка с сообщением "Не существует заказа с id = %d"

8. Возбновление заказа (перевод из отмены в работу):
    - путь: `orders/{order_id}/renew`
    - метод: `PATCH`
    - возможные query-параметры: нет
    - возможное тело запроса: не подразумевается
    - возможные ошибки:
        - при попытке возобновить завершенный заказ (статус которого `completed`), возникнет ошибка с сообщением "Нельзя возобновить завершённый заказ"
        - при попытке возобновить уже активный заказ (статус которого `active`), возникнет ошибка с сообщением "Заказ уже находится в работе"
        - при обращении к несуществующему заказу, возникнет ошибка с сообщением "Не существует заказа с id = %d"

9. Просмотр истории движения товаров с фильтрами и настраиваемой пагинацией:
    - путь: `/flows`
    - метод: `GET`
    - возможные query-параметры:
        - `page`: передача номера просматриваемой страницы
            Пример: ```page=1```
    - возможное тело запроса:
        - `perPage`: сколько элементов отображать на одной странице
            - обязательность: нет (по умолчанию - 5)
            - тип: integer
            - пример: ```"perPage": 6```
        - `filters`: список параметров фильтрации
            - обязательность: нет
            - тип: объект
            - поля: 
                - `warehouse` (название или id склада), `product` (название или id продукта)
                    - тип: объект
                    - возможные поля:
                        - `order`: направление сортировки
                            - возможные значения: `order_asc`, `order_desc`
                        - `opeartor`: тип сравнения
                            - возможные значения: `=`, `like`
                        - `value`: значение для поиска
                            - необходимо при указании `operator`
                            - возможные типы: 
                                - string: поиск и сортировка происходит по названию
                                - integer: поиск и сортировка происходит по id
                - `created_at` (время создания записи истории движения товара)
                    - тип: объект
                    - возможные поля:
                        - `order`: направление сортировки
                            - возможные значения: `order_asc`, `order_desc`
                        - `opeartor`: тип сравнения
                            - возможные значения: `=`, `after`, `before`, `between`
                        - `value`: значение для поиска
                            - тип: date
                            - необходимо при указании `operator`, если `operator` != `is_null`/`is_not_null`/`between`
                        - `value_start`: значение начала диапазона
                            - тип: date
                            - необходимо, если `operator` = `between`
                        - `value_end`: значение конца диапазона
                            - тип: date
                            - необходимо, если `operator` = `between`
            - пример:
            ```
            {
                "filters": {
                    "product": {
                        "order": "order_asc"
                    },
                    "created_at": {
                        "order": "order_asc",
                        "operator": "between",
                        "value_start": "2025-05-12 10:00:00",
                        "value_end": "2025-05-12 10:05:00"
                    }
                }
            }
            ```

## Использование
### Требования
Для запуска проекта достаточно использовать Docker. 
При его отсутствии необходимы PHP v8.2+, MySQL v8.0+, Composer v2.

### Установка
1. Создайте env-файл в соответсвии с env-example.

2. *При использовании докера*
    - Запустите приложение с помощью следующей команды:
    ```sh
    docker-compose up -d --build
    ```

    - Перейдите внутрь контейнера PHP:
    ```sh
    docker exec -it php82-cont-test bash
    ```

3. Установите необходимые зависимости:
    ```sh
    composer install
    ```

4. Сгенерируйте секретный ключ приложения:
    ```sh
    php artisan key:generate
    ```

5. Примените миграции:
    ```sh
    php artisan migrate
    ```

6. Наполните базу данных тестовыми данными:
    ```sh
    php artisan db:seed
    ```

7. *Без использования докера*

    Запустите локальный сервер Laravel:
    ```sh
    php artisan serve --port={номер-порта-указанный-в-env} (`--port=8080`)
    ```

8. Откройте в браузере страницу `localhost:{номер-порта-указанный-в-env}` (например, `localhost:8080`).

Можно начинать пользоваться приложением.

